<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B2B Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.5rem;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding: 0 20px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .tab-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .tab-btn.active {
            background: white;
            color: var(--primary);
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        .purchase-card .card-icon {
            background: rgba(52, 152, 219, 0.1);
            color: var(--secondary);
        }
        
        .sales-card .card-icon {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success);
        }
        
        .profit-card .card-icon {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }
        
        .card h3 {
            font-size: 1rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .card .value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .card .change {
            font-size: 0.9rem;
            color: #666;
        }
        
        .change.positive {
            color: var(--success);
        }
        
        .change.negative {
            color: var(--danger);
        }
        
        .dashboard-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .section-header h2 {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }
        
        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .section-actions {
            display: flex;
            gap: 10px;
        }
        
        .section-actions button {
            padding: 8px 15px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .section-actions button:hover {
            background: #2980b9;
        }
        
        .section-actions button i {
            margin-right: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f8f9fa;
        }
        
        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
            border-bottom: 2px solid #eee;
            font-size: 0.9rem;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-delivered {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success);
        }
        
        .status-pending {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }
        
        .status-cancelled {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }
        
        .chart-container {
            height: 300px;
            margin-top: 20px;
        }
        
        .supplier-table {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            background: var(--primary);
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 1.5rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary);
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .item-row {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .bill-item-row {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .remove-item {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 5px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .add-item-btn {
            background: var(--success);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }
        
        .address-box {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .address-box h4 {
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 40px;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
        }
        
        .signature-box {
            text-align: center;
        }
        
        .signature-line {
            width: 200px;
            height: 1px;
            background: #000;
            margin: 40px auto 10px;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            margin-top: 50px;
            border-top: 1px solid #eee;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .loading i {
            font-size: 2rem;
            color: var(--secondary);
            margin-bottom: 10px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .numeric {
            text-align: right;
        }
        
        .amount-in-words {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .item-row {
                grid-template-columns: 1fr;
            }
            
            .bill-item-row {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            th, td {
                padding: 8px;
                font-size: 0.8rem;
            }
            
            .signature-section {
                grid-template-columns: 1fr;
            }
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            #delivery-analysis-table, #delivery-analysis-table * {
                visibility: visible;
            }
            #delivery-analysis-table {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-boxes"></i>
                <h1>Inventory Management System</h1>
            </div>
            <div>
                <button class="btn btn-secondary" onclick="loadDataFromGoogleSheets()">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
            </div>
        </div>
        
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="openTab('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="tab-btn" onclick="openTab('orders')">
                <i class="fas fa-clipboard-list"></i> All Orders
            </button>
            <button class="tab-btn" onclick="openTab('delivery-analysis')">
                <i class="fas fa-truck"></i> Delivery Analysis
            </button>
            <button class="tab-btn" onclick="showDeliveryModal()">
                <i class="fas fa-file-export"></i> Delivery Challan
            </button>
            <button class="tab-btn" onclick="showBillModal()">
                <i class="fas fa-file-invoice-dollar"></i> Generate Bill
            </button>
        </div>
    </header>
    
    <div class="container">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-cards">
                <div class="card purchase-card">
                    <div class="card-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <h3>Total Purchase</h3>
                    <div class="value" id="total-purchase">0.00</div>
                    <div class="change positive" id="purchase-change">Loading...</div>
                </div>
                
                <div class="card sales-card">
                    <div class="card-icon">
                        <i class="fas fa-taka-sign"></i>
                    </div>
                    <h3>Total Sales</h3>
                    <div class="value" id="total-sales">0.00 TK</div>
                    <div class="change positive" id="sales-change">Loading...</div>
                </div>
                
                <div class="card profit-card">
                    <div class="card-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3>Total Profit</h3>
                    <div class="value" id="total-profit">0.00</div>
                    <div class="change positive" id="profit-change">Loading...</div>
                </div>
            </div>
            
            <div class="dashboard-section">
                <div class="section-header">
                    <h2>Monthly Performance</h2>
                </div>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
            
            <div class="dashboard-section">
                <div class="section-header">
                    <h2>Recent Orders</h2>
                </div>
                <div class="supplier-table">
                    <table id="recent-orders">
                        <thead>
                            <tr>
                                <th>PO Number</th>
                                <th>PR No</th>
                                <th>Delivery To</th>
                                <th>Item Description</th>
                                <th>Qty</th>
                                <th class="numeric">Bill Amount</th>
                                <th>Delivery Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" class="loading">
                                    <i class="fas fa-spinner fa-spin"></i><br>
                                    Loading data from Google Sheets...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- All Orders Tab -->
        <div id="orders" class="tab-content">
            <div class="dashboard-section">
                <div class="section-header">
                    <h2>All Orders</h2>
                    <div class="section-actions">
                        <button onclick="exportToExcel()">
                            <i class="fas fa-file-export"></i> Export Excel
                        </button>
                    </div>
                </div>
                
                <div class="filters">
                    <div class="filter-group">
                        <label for="statusFilter">Delivery Status</label>
                        <select id="statusFilter" onchange="filterOrders()">
                            <option value="">All Status</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Pending">Pending</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="dateFilter">Month-Year</label>
                        <input type="text" id="dateFilter" placeholder="Select Month" onchange="filterOrders()">
                    </div>
                    <div class="filter-group">
                        <label for="searchFilter">Search</label>
                        <input type="text" id="searchFilter" placeholder="Search..." onkeyup="filterOrders()">
                    </div>
                </div>
                
                <div class="supplier-table">
                    <table id="all-orders">
                        <thead>
                            <tr>
                                <th>SL</th>
                                <th>Date</th>
                                <th>PO Number</th>
                                <th>PR No</th>
                                <th>Item</th>
                                <th>Code</th>
                                <th>Item Description</th>
                                <th>Delivery To</th>
                                <th>Qty</th>
                                <th class="numeric">Purchase Price</th>
                                <th class="numeric">Selling Price</th>
                                <th class="numeric">Purchase Amount</th>
                                <th class="numeric">Selling Amount</th>
                                <th>Delivery Date</th>
                                <th>Delivery Status</th>
                                <th>Bill No</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="16" class="loading">
                                    <i class="fas fa-spinner fa-spin"></i><br>
                                    Loading data from Google Sheets...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Delivery Analysis Tab -->
        <div id="delivery-analysis" class="tab-content">
            <div class="dashboard-section">
                <div class="section-header">
                    <h2>Delivery Location Analysis</h2>
                    <div class="section-actions">
                        <button onclick="printDeliveryAnalysis()">
                            <i class="fas fa-print"></i> Print Report
                        </button>
                    </div>
                </div>
                <div class="supplier-table">
                    <table id="delivery-analysis-table">
                        <thead>
                            <tr>
                                <th>Delivery To</th>
                                <th>Total Orders</th>
                                <th>Total Qty</th>
                                <th class="numeric">Total Purchase</th>
                                <th class="numeric">Total Sales</th>
                                <th class="numeric">Profit</th>
                                <th>Profit %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" class="loading">
                                    <i class="fas fa-spinner fa-spin"></i><br>
                                    Loading delivery data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delivery Challan Modal -->
    <div id="deliveryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Generate Delivery Challan</h3>
                <button class="close-modal" onclick="closeDeliveryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Delivery Challan No</label>
                        <input type="text" id="deliveryNo" value="DC-1001" readonly>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="deliveryDate">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Select PO Number</label>
                        <select id="poSelect" onchange="updatePRNoAndDeliveryTo()">
                            <option value="">-- Select PO Number --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>PR No</label>
                        <input type="text" id="prNo" readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Delivery To</label>
                        <select id="deliveryToSelect" onchange="updateDeliveryAddress()">
                            <option value="">-- Select Delivery To --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Delivery Address</label>
                        <textarea id="deliveryAddress" rows="3" readonly></textarea>
                    </div>
                </div>
                
                <div class="address-box">
                    <h4>From MUDI</h4>
                    <p>Location: House#2, Road No #96, Gulshan-2</p>
                    <input type="text" id="fromNumber" placeholder="Enter Contact Number">
                </div>
                
                <h4>Items List</h4>
                <div id="deliveryItems">
                    <div class="item-row">
                        <input type="text" placeholder="Item" class="item-name" required>
                        <input type="text" placeholder="Item Description" class="item-desc" required>
                        <input type="text" placeholder="Unit" class="item-unit" required>
                        <input type="number" placeholder="Quantity" class="item-qty" min="1" value="1" required>
                        <button type="button" class="remove-item" onclick="removeDeliveryItem(this)">&times;</button>
                    </div>
                </div>
                
                <button type="button" class="add-item-btn" onclick="addDeliveryItem()">
                    <i class="fas fa-plus"></i> Add Another Item
                </button>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeDeliveryModal()">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="generateDelivery()">Generate & Print Challan</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bill Generator Modal -->
    <div id="billModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Generate Bill</h3>
                <button class="close-modal" onclick="closeBillModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Select Delivery Challan</label>
                        <select id="challanSelect" onchange="loadBillFromChallan()">
                            <option value="">-- Select Delivery Challan --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Bill No</label>
                        <input type="text" id="billNo" value="BILL-1001" readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="billDate">
                    </div>
                    <div class="form-group">
                        <label>PR No</label>
                        <input type="text" id="billPRNo" readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Delivery To</label>
                        <input type="text" id="billDeliveryTo" readonly>
                    </div>
                    <div class="form-group">
                        <label>Delivery Address</label>
                        <textarea id="billDeliveryAddress" rows="2" readonly></textarea>
                    </div>
                </div>
                
                <h4>Items List</h4>
                <div id="billItems">
                    <div class="bill-item-row">
                        <input type="text" placeholder="Item" class="bill-item-name" required>
                        <input type="text" placeholder="Item Description" class="bill-item-desc" required>
                        <input type="number" placeholder="Qty" class="bill-item-qty" min="1" value="1" required oninput="calculateItemTotal(this)">
                        <input type="number" placeholder="Rate" class="bill-item-rate" min="0" step="0.01" required oninput="calculateItemTotal(this)">
                        <input type="text" placeholder="Amount" class="bill-item-total" readonly>
                        <button type="button" class="remove-item" onclick="removeBillItem(this)">&times;</button>
                    </div>
                </div>
                
                <button type="button" class="add-item-btn" onclick="addBillItem()">
                    <i class="fas fa-plus"></i> Add Another Item
                </button>
                
                <div class="form-row" style="margin-top: 20px;">
                    <div class="form-group">
                        <label>Total Quantity</label>
                        <input type="text" id="totalQty" value="0" readonly>
                    </div>
                    <div class="form-group">
                        <label>Total Amount</label>
                        <input type="text" id="totalAmount" value="0.00" readonly>
                    </div>
                </div>
                
                <div id="amountInWords" class="amount-in-words" style="display: none;">
                    Amount in Words: <span id="amountWords"></span>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeBillModal()">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="generateBill()">Generate & Print Bill</button>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <p>B2B Management System &copy; 2026 | MUDI</p>
    </footer>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const SPREADSHEET_ID = '1BO2-AgJxNF0jp2l6AS14P8mBr8ChqEwHfL6hChFfrSE';
        
        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let inventoryData = [];
        let monthlyChart = null;
        let deliveryChallans = JSON.parse(localStorage.getItem('deliveryChallans')) || [];
        let bills = JSON.parse(localStorage.getItem('bills')) || [];
        let lastChallanNo = 1000;
        let lastBillNo = 1000;
        
        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('deliveryDate').value = today;
            document.getElementById('billDate').value = today;
            
            // Initialize date picker for month filter
            flatpickr("#dateFilter", {
                plugins: [new monthSelectPlugin({
                    shorthand: true,
                    dateFormat: "F Y",
                    altFormat: "F Y",
                    theme: "light"
                })],
                onChange: function(selectedDates, dateStr, instance) {
                    filterOrders();
                }
            });
            
            // Load data
            loadDataFromGoogleSheets();
            
            // Load saved data
            loadSavedData();
        });
        
        // Month select plugin for flatpickr
        class monthSelectPlugin {
            constructor(config) {
                this.config = config;
            }
            
            init(fp) {
                this.fp = fp;
                this.createMonthNav();
                fp.loadedPlugins.push("monthSelect");
            }
            
            createMonthNav() {
                const self = this;
                const container = document.createElement("div");
                container.className = "flatpickr-monthSelect-months";
                
                for (let i = 0; i < 12; i++) {
                    const month = document.createElement("div");
                    month.className = "flatpickr-monthSelect-month";
                    month.textContent = this.fp.l10n.months.shorthand[i];
                    month.addEventListener("click", function() {
                        const date = new Date(self.fp.currentYear, i, 1);
                        self.fp.setDate(date, true);
                        self.fp.close();
                    });
                    container.appendChild(month);
                }
                
                this.fp.calendarContainer.appendChild(container);
            }
        }
        
        // ============================================
        // GOOGLE SHEETS DATA LOADING
        // ============================================
        async function loadDataFromGoogleSheets() {
            showLoading(true);
            
            try {
                // Method 1: Using Google Sheets API with API key
                // You need to enable Google Sheets API and get an API key
                const API_KEY = ''; // Add your API key here
                
                if (!API_KEY) {
                    console.warn('No API key provided. Using alternative method.');
                    inventoryData = await loadDataAlternative();
                } else {
                    const range = 'A:Z';
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Products!${range}?key=${API_KEY}`;
                    
                    const response = await fetch(url);
                    const result = await response.json();
                    
                    if (!result.values || result.values.length === 0) {
                        throw new Error('No data found in sheet');
                    }
                    
                    const headers = result.values[0];
                    const data = [];
                    
                    for (let i = 1; i < result.values.length; i++) {
                        const row = result.values[i];
                        const rowData = {};
                        
                        headers.forEach((header, index) => {
                            rowData[header.trim()] = index < row.length ? row[index] : '';
                        });
                        
                        // Convert numeric fields
                        ['Qty', 'Purchase_Price', 'Selling_Price', 'Purchase_Amount', 
                         'Selling_Amount', 'Bill_Amount'].forEach(field => {
                            if (rowData[field] !== undefined && rowData[field] !== '') {
                                rowData[field] = parseFloat(rowData[field]) || 0;
                            }
                        });
                        
                        // Ensure SL is a number
                        if (rowData['SL']) {
                            rowData['SL'] = parseInt(rowData['SL']) || i;
                        } else {
                            rowData['SL'] = i;
                        }
                        
                        data.push(rowData);
                    }
                    
                    inventoryData = data;
                    console.log(`Loaded ${data.length} records from Google Sheets`);
                }
                
                updateAllDisplays();
                showLoading(false);
                
            } catch (error) {
                console.error('Error loading data:', error);
                showLoading(false);
                alert('Error loading data from Google Sheets. Please check the connection.');
            }
        }
        
        async function loadDataAlternative() {
            // Alternative method using CSV export
            try {
                const csvUrl = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=Products`;
                const response = await fetch(csvUrl);
                const csvText = await response.text();
                return parseCSV(csvText);
            } catch (error) {
                console.error('CSV method failed:', error);
                return [];
            }
        }
        
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
                const rowData = {};
                
                headers.forEach((header, index) => {
                    rowData[header] = index < values.length ? values[index] : '';
                    
                    // Convert numeric fields
                    if (['Qty', 'Purchase_Price', 'Selling_Price', 'Purchase_Amount', 
                         'Selling_Amount', 'Bill_Amount', 'SL'].includes(header)) {
                        const numValue = parseFloat(rowData[header]);
                        rowData[header] = isNaN(numValue) ? 0 : numValue;
                    }
                    
                    // Ensure SL is a number
                    if (header === 'SL' && (!rowData[header] || rowData[header] === '')) {
                        rowData[header] = i;
                    }
                });
                
                data.push(rowData);
            }
            
            return data;
        }
        
        // ============================================
        // DATA PROCESSING AND DISPLAY
        // ============================================
        function updateAllDisplays() {
            updateDashboard();
            updateRecentOrders();
            updateAllOrdersTable();
            updateDeliveryAnalysis();
            updateMonthlyChart();
            populateDeliveryDropdowns();
            updateChallanSelect();
        }
        
        function updateDashboard() {
            if (inventoryData.length === 0) {
                document.getElementById('total-purchase').textContent = '0.00';
                document.getElementById('total-sales').textContent = '0.00 TK';
                document.getElementById('total-profit').textContent = '0.00';
                return;
            }
            
            let totalPurchase = 0;
            let totalSales = 0;
            
            inventoryData.forEach(item => {
                const purchaseAmt = parseFloat(item['Purchase_Amount']) || 
                                   (parseFloat(item['Purchase_Price']) || 0) * (parseFloat(item['Qty']) || 0);
                const salesAmt = parseFloat(item['Selling_Amount']) || 
                                (parseFloat(item['Selling_Price']) || 0) * (parseFloat(item['Qty']) || 0);
                
                totalPurchase += purchaseAmt;
                totalSales += salesAmt;
            });
            
            const totalProfit = totalSales - totalPurchase;
            const profitMargin = totalPurchase > 0 ? (totalProfit / totalPurchase * 100).toFixed(2) : 0;
            
            document.getElementById('total-purchase').textContent = formatNumber(totalPurchase);
            document.getElementById('total-sales').textContent = formatNumber(totalSales) + ' TK';
            document.getElementById('total-profit').textContent = formatNumber(totalProfit);
            
            document.getElementById('purchase-change').textContent = `Margin: ${profitMargin}%`;
            document.getElementById('sales-change').textContent = `Based on ${inventoryData.length} records`;
            document.getElementById('profit-change').textContent = totalProfit >= 0 ? 'Profitable' : 'Loss';
            
            if (totalProfit < 0) {
                document.getElementById('profit-change').classList.remove('positive');
                document.getElementById('profit-change').classList.add('negative');
            }
        }
        
        function updateRecentOrders() {
            const tableBody = document.querySelector('#recent-orders tbody');
            tableBody.innerHTML = '';
            
            if (inventoryData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7">No data available</td></tr>';
                return;
            }
            
            // Get recent 10 orders
            const recentOrders = [...inventoryData]
                .sort((a, b) => new Date(b['Date'] || 0) - new Date(a['Date'] || 0))
                .slice(0, 10);
            
            recentOrders.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order['PO_Number'] || 'N/A'}</td>
                    <td>${order['PR_No'] || 'N/A'}</td>
                    <td>${order['Delivery_To'] || 'N/A'}</td>
                    <td>${order['Item_Description'] || 'N/A'}</td>
                    <td>${order['Qty'] || 0}</td>
                    <td class="numeric">${formatNumber(order['Bill_Amount'] || 0)}</td>
                    <td><span class="status-badge ${getStatusClass(order['Delivery_Status'])}">
                        ${order['Delivery_Status'] || 'Pending'}
                    </span></td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function updateAllOrdersTable() {
            const tableBody = document.querySelector('#all-orders tbody');
            tableBody.innerHTML = '';
            
            if (inventoryData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="16">No data available</td></tr>';
                return;
            }
            
            inventoryData.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order['SL'] || ''}</td>
                    <td>${formatDate(order['Date'])}</td>
                    <td>${order['PO_Number'] || 'N/A'}</td>
                    <td>${order['PR_No'] || 'N/A'}</td>
                    <td>${order['Item'] || 'N/A'}</td>
                    <td>${order['Code'] || 'N/A'}</td>
                    <td>${order['Item_Description'] || 'N/A'}</td>
                    <td>${order['Delivery_To'] || 'N/A'}</td>
                    <td>${order['Qty'] || 0}</td>
                    <td class="numeric">${formatNumber(order['Purchase_Price'] || 0)}</td>
                    <td class="numeric">${formatNumber(order['Selling_Price'] || 0)}</td>
                    <td class="numeric">${formatNumber(order['Purchase_Amount'] || 0)}</td>
                    <td class="numeric">${formatNumber(order['Selling_Amount'] || 0)}</td>
                    <td>${formatDate(order['Delivery_Date'])}</td>
                    <td><span class="status-badge ${getStatusClass(order['Delivery_Status'])}">
                        ${order['Delivery_Status'] || 'Pending'}
                    </span></td>
                    <td>${order['Bill_No'] || 'N/A'}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function filterOrders() {
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            
            const tableBody = document.querySelector('#all-orders tbody');
            const rows = tableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                if (row.classList.contains('loading')) return;
                
                const statusCell = row.querySelector('td:nth-child(15)');
                const dateCell = row.querySelector('td:nth-child(2)');
                const rowText = row.textContent.toLowerCase();
                
                let showRow = true;
                
                // Filter by status
                if (statusFilter && statusCell) {
                    const status = statusCell.textContent.trim();
                    if (status !== statusFilter) {
                        showRow = false;
                    }
                }
                
                // Filter by month-year
                if (dateFilter && dateCell) {
                    const date = new Date(dateCell.textContent);
                    const filterDate = new Date(dateFilter);
                    const rowMonthYear = `${date.getMonth()+1}/${date.getFullYear()}`;
                    const filterMonthYear = `${filterDate.getMonth()+1}/${filterDate.getFullYear()}`;
                    
                    if (rowMonthYear !== filterMonthYear) {
                        showRow = false;
                    }
                }
                
                // Filter by search
                if (searchFilter && !rowText.includes(searchFilter)) {
                    showRow = false;
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }
        
        function updateDeliveryAnalysis() {
            const tableBody = document.querySelector('#delivery-analysis-table tbody');
            tableBody.innerHTML = '';
            
            if (inventoryData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7">No data available</td></tr>';
                return;
            }
            
            // Group by Delivery_To
            const deliveryMap = new Map();
            
            inventoryData.forEach(order => {
                const deliveryTo = order['Delivery_To'] || 'Unknown';
                const purchaseAmt = parseFloat(order['Purchase_Amount']) || 
                                   (parseFloat(order['Purchase_Price']) || 0) * (parseFloat(order['Qty']) || 0);
                const salesAmt = parseFloat(order['Selling_Amount']) || 
                                (parseFloat(order['Selling_Price']) || 0) * (parseFloat(order['Qty']) || 0);
                const qty = parseFloat(order['Qty']) || 0;
                
                if (!deliveryMap.has(deliveryTo)) {
                    deliveryMap.set(deliveryTo, {
                        purchase: 0,
                        sales: 0,
                        qty: 0,
                        count: 0,
                        profit: 0
                    });
                }
                
                const data = deliveryMap.get(deliveryTo);
                data.purchase += purchaseAmt;
                data.sales += salesAmt;
                data.qty += qty;
                data.profit = data.sales - data.purchase;
                data.count += 1;
            });
            
            // Convert to array and sort by sales
            const deliveryArray = Array.from(deliveryMap.entries())
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.sales - a.sales);
            
            // Populate table
            deliveryArray.forEach(delivery => {
                const profitPercent = delivery.purchase > 0 ? 
                    ((delivery.profit / delivery.purchase) * 100).toFixed(2) : '0.00';
                const profitClass = delivery.profit >= 0 ? 'positive' : 'negative';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${delivery.name}</strong></td>
                    <td>${delivery.count}</td>
                    <td>${delivery.qty}</td>
                    <td class="numeric">${formatNumber(delivery.purchase)}</td>
                    <td class="numeric">${formatNumber(delivery.sales)}</td>
                    <td class="numeric ${profitClass}">${formatNumber(delivery.profit)}</td>
                    <td class="${profitClass}">${profitPercent}%</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function updateMonthlyChart() {
            const ctx = document.getElementById('monthlyChart');
            if (!ctx) return;
            
            if (monthlyChart) {
                monthlyChart.destroy();
            }
            
            // Group data by month
            const monthlyData = groupDataByMonth();
            
            monthlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthlyData.labels,
                    datasets: [
                        {
                            label: 'Purchase',
                            data: monthlyData.purchase,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Sales',
                            data: monthlyData.sales,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function groupDataByMonth() {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const purchaseData = new Array(12).fill(0);
            const salesData = new Array(12).fill(0);
            
            inventoryData.forEach(item => {
                if (item['Date']) {
                    try {
                        const date = new Date(item['Date']);
                        const month = date.getMonth();
                        
                        const purchaseAmt = parseFloat(item['Purchase_Amount']) || 
                                           (parseFloat(item['Purchase_Price']) || 0) * (parseFloat(item['Qty']) || 0);
                        const salesAmt = parseFloat(item['Selling_Amount']) || 
                                        (parseFloat(item['Selling_Price']) || 0) * (parseFloat(item['Qty']) || 0);
                        
                        purchaseData[month] += purchaseAmt;
                        salesData[month] += salesAmt;
                    } catch (e) {
                        console.warn('Invalid date format:', item['Date']);
                    }
                }
            });
            
            return {
                labels: months,
                purchase: purchaseData,
                sales: salesData
            };
        }
        
        // ============================================
        // DELIVERY CHALLAN FUNCTIONS
        // ============================================
        function showDeliveryModal() {
            document.getElementById('deliveryModal').style.display = 'flex';
            generateDeliveryNumber();
            populateDeliveryDropdowns();
        }
        
        function closeDeliveryModal() {
            document.getElementById('deliveryModal').style.display = 'none';
        }
        
        function generateDeliveryNumber() {
            // Find the next available challan number
            const existingNumbers = deliveryChallans.map(c => {
                const match = c.challanNo.match(/\d+/);
                return match ? parseInt(match[0]) : 0;
            });
            
            const maxNumber = Math.max(1000, ...existingNumbers);
            lastChallanNo = maxNumber + 1;
            document.getElementById('deliveryNo').value = `DC-${lastChallanNo}`;
        }
        
        function populateDeliveryDropdowns() {
            const poSelect = document.getElementById('poSelect');
            const deliveryToSelect = document.getElementById('deliveryToSelect');
            
            if (!poSelect || !deliveryToSelect) return;
            
            // Clear existing options
            poSelect.innerHTML = '<option value="">-- Select PO Number --</option>';
            deliveryToSelect.innerHTML = '<option value="">-- Select Delivery To --</option>';
            
            if (inventoryData.length === 0) return;
            
            // Get unique PO Numbers and Delivery To locations
            const poNumbers = new Set();
            const deliveryLocations = new Map();
            
            inventoryData.forEach(item => {
                if (item['PO_Number'] && item['PO_Number'].trim() !== '') {
                    poNumbers.add(item['PO_Number']);
                }
                
                if (item['Delivery_To'] && item['Delivery_To'].trim() !== '') {
                    deliveryLocations.set(item['Delivery_To'], item['Delivery_Address'] || '');
                }
            });
            
            // Add PO Numbers to dropdown
            poNumbers.forEach(poNumber => {
                const option = document.createElement('option');
                option.value = poNumber;
                option.textContent = poNumber;
                poSelect.appendChild(option);
            });
            
            // Add Delivery To locations to dropdown
            deliveryLocations.forEach((address, location) => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                option.setAttribute('data-address', address);
                deliveryToSelect.appendChild(option);
            });
        }
        
        function updatePRNoAndDeliveryTo() {
            const poNumber = document.getElementById('poSelect').value;
            const prNoInput = document.getElementById('prNo');
            const deliveryToSelect = document.getElementById('deliveryToSelect');
            
            if (!poNumber) {
                prNoInput.value = '';
                return;
            }
            
            // Find the first matching record with this PO Number
            const matchingRecord = inventoryData.find(item => item['PO_Number'] === poNumber);
            
            if (matchingRecord) {
                prNoInput.value = matchingRecord['PR_No'] || '';
                
                // Update Delivery To dropdown
                if (matchingRecord['Delivery_To']) {
                    deliveryToSelect.value = matchingRecord['Delivery_To'];
                    updateDeliveryAddress();
                }
                
                // Populate items for this PO
                populateItemsForPO(poNumber);
            }
        }
        
        function updateDeliveryAddress() {
            const deliveryTo = document.getElementById('deliveryToSelect').value;
            const addressTextarea = document.getElementById('deliveryAddress');
            
            if (!deliveryTo) {
                addressTextarea.value = '';
                return;
            }
            
            // Find the address for this delivery location
            const matchingRecord = inventoryData.find(item => item['Delivery_To'] === deliveryTo);
            
            if (matchingRecord && matchingRecord['Delivery_Address']) {
                addressTextarea.value = matchingRecord['Delivery_Address'];
            } else {
                // Try to find in dropdown options
                const selectedOption = document.querySelector(`#deliveryToSelect option[value="${deliveryTo}"]`);
                if (selectedOption && selectedOption.dataset.address) {
                    addressTextarea.value = selectedOption.dataset.address;
                } else {
                    addressTextarea.value = '';
                }
            }
        }
        
        function populateItemsForPO(poNumber) {
            const itemsContainer = document.getElementById('deliveryItems');
            itemsContainer.innerHTML = '';
            
            // Find all items for this PO Number
            const poItems = inventoryData.filter(item => item['PO_Number'] === poNumber);
            
            if (poItems.length === 0) {
                addDeliveryItem(); // Add empty row if no items found
                return;
            }
            
            // Add items from the PO
            poItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <input type="text" placeholder="Item" class="item-name" value="${item['Item'] || ''}" required>
                    <input type="text" placeholder="Item Description" class="item-desc" value="${item['Item_Description'] || ''}" required>
                    <input type="text" placeholder="Unit" class="item-unit" value="${item['Unit'] || ''}" required>
                    <input type="number" placeholder="Quantity" class="item-qty" min="1" value="${item['Qty'] || 1}" required>
                    <button type="button" class="remove-item" onclick="removeDeliveryItem(this)">&times;</button>
                `;
                itemsContainer.appendChild(div);
            });
        }
        
        function addDeliveryItem() {
            const container = document.getElementById('deliveryItems');
            const div = document.createElement('div');
            div.className = 'item-row';
            div.innerHTML = `
                <input type="text" placeholder="Item" class="item-name" required>
                <input type="text" placeholder="Item Description" class="item-desc" required>
                <input type="text" placeholder="Unit" class="item-unit" required>
                <input type="number" placeholder="Quantity" class="item-qty" min="1" value="1" required>
                <button type="button" class="remove-item" onclick="removeDeliveryItem(this)">&times;</button>
            `;
            container.appendChild(div);
        }
        
        function removeDeliveryItem(button) {
            const container = document.getElementById('deliveryItems');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }
        
        function generateDelivery() {
            const challanNo = document.getElementById('deliveryNo').value;
            const date = document.getElementById('deliveryDate').value;
            const poNumber = document.getElementById('poSelect').value;
            const prNo = document.getElementById('prNo').value;
            const deliveryTo = document.getElementById('deliveryToSelect').value;
            const deliveryAddress = document.getElementById('deliveryAddress').value;
            const fromNumber = document.getElementById('fromNumber').value;
            const items = [];
            
            // Collect items
            document.querySelectorAll('#deliveryItems .item-row').forEach((row, index) => {
                const itemName = row.querySelector('.item-name').value;
                const desc = row.querySelector('.item-desc').value;
                const unit = row.querySelector('.item-unit').value;
                const qty = row.querySelector('.item-qty').value;
                
                if (itemName && desc && unit && qty) {
                    items.push({
                        serial: index + 1,
                        item: itemName,
                        description: desc,
                        unit: unit,
                        quantity: parseInt(qty) || 1
                    });
                }
            });
            
            if (items.length === 0) {
                alert('Please add at least one item');
                return;
            }
            
            if (!deliveryTo || !deliveryAddress) {
                alert('Please select Delivery To and ensure address is filled');
                return;
            }
            
            // Save delivery challan
            const deliveryChallan = {
                challanNo: challanNo,
                date: date,
                poNumber: poNumber,
                prNo: prNo,
                deliveryTo: deliveryTo,
                deliveryAddress: deliveryAddress,
                fromNumber: fromNumber,
                items: items,
                createdAt: new Date().toISOString()
            };
            
            deliveryChallans.push(deliveryChallan);
            localStorage.setItem('deliveryChallans', JSON.stringify(deliveryChallans));
            
            // Update challan select dropdown
            updateChallanSelect();
            
            // Generate printable delivery challan
            printDeliveryChallan(deliveryChallan);
            
            alert('Delivery Challan generated successfully!');
            closeDeliveryModal();
        }
        
        function printDeliveryChallan(challanData) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Delivery Challan - ${challanData.challanNo}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .header h1 { color: #2c3e50; margin-bottom: 5px; }
                        .challan-info { text-align: right; margin-bottom: 30px; }
                        .address-section { 
                            display: flex; 
                            justify-content: space-between;
                            margin-bottom: 30px;
                        }
                        .address-box { 
                            width: 48%; 
                            border: 1px solid #000;
                            padding: 15px;
                        }
                        .address-box h3 { margin-top: 0; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                        th, td { border: 1px solid #000; padding: 10px; text-align: left; }
                        th { background-color: #f0f0f0; }
                        .signature-section { 
                            display: flex; 
                            justify-content: space-between;
                            margin-top: 50px;
                        }
                        .signature-box { 
                            text-align: center;
                            width: 30%;
                        }
                        .signature-line { 
                            width: 200px; 
                            height: 1px; 
                            background: #000; 
                            margin: 40px auto 10px;
                        }
                        .bold { font-weight: bold; }
                        .text-right { text-align: right; }
                        .text-center { text-align: center; }
                        @media print {
                            body { margin: 10px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DELIVERY CHALLAN</h1>
                        <div class="challan-info">
                            <div><strong>Challan No:</strong> ${challanData.challanNo}</div>
                            <div><strong>Date:</strong> ${formatDate(challanData.date)}</div>
                        </div>
                    </div>
                    
                    <div class="address-section">
                        <div class="address-box">
                            <h3>From:</h3>
                            <p><strong>PO Number:</strong> ${challanData.poNumber || 'N/A'}</p>
                            <p>From MUDI</p>
                            <p>Location: House#2, Road No #96, Gulshan-2</p>
                            <p>${challanData.fromNumber ? 'Number: ' + challanData.fromNumber : ''}</p>
                        </div>
                        
                        <div class="address-box">
                            <h3>To:</h3>
                            <p><strong>Delivery To:</strong> ${challanData.deliveryTo}</p>
                            <p><strong>Delivery Address:</strong><br>${challanData.deliveryAddress.replace(/\n/g, '<br>')}</p>
                            <p><strong>PR No:</strong> ${challanData.prNo || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>SL</th>
                                <th>Item</th>
                                <th>Item Description</th>
                                <th>Unit</th>
                                <th>Quantity</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${challanData.items.map(item => `
                                <tr>
                                    <td>${item.serial}</td>
                                    <td>${item.item}</td>
                                    <td>${item.description}</td>
                                    <td>${item.unit}</td>
                                    <td>${item.quantity}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="signature-section">
                        <div class="signature-box">
                            <p>Created By</p>
                            <div class="signature-line"></div>
                            <p class="bold">Salim Bhuiyan</p>
                            <p>Assistant Manager</p>
                        </div>
                        
                        <div class="signature-box">
                            <p>Authorised By</p>
                            <div class="signature-line"></div>
                            <p class="bold">Masru Ahmed Rafi</p>
                            <p>CEO</p>
                        </div>
                        
                        <div class="signature-box">
                            <p>Received By</p>
                            <div class="signature-line"></div>
                            <p>&nbsp;</p>
                            <p>&nbsp;</p>
                        </div>
                    </div>
                    
                    <script>
                        window.onload = function() {
                            window.print();
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // ============================================
        // BILL GENERATOR FUNCTIONS
        // ============================================
        function showBillModal() {
            document.getElementById('billModal').style.display = 'flex';
            updateChallanSelect();
            generateBillNumber();
        }
        
        function closeBillModal() {
            document.getElementById('billModal').style.display = 'none';
        }
        
        function updateChallanSelect() {
            const challanSelect = document.getElementById('challanSelect');
            
            if (!challanSelect) return;
            
            challanSelect.innerHTML = '<option value="">-- Select Delivery Challan --</option>';
            
            if (deliveryChallans.length === 0) return;
            
            // Add delivery challans to dropdown
            deliveryChallans.forEach((challan, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${challan.challanNo} - ${challan.poNumber} - ${challan.deliveryTo}`;
                challanSelect.appendChild(option);
            });
        }
        
        function generateBillNumber() {
            // Find the next available bill number
            const existingNumbers = bills.map(b => {
                const match = b.billNo.match(/\d+/);
                return match ? parseInt(match[0]) : 0;
            });
            
            const maxNumber = Math.max(1000, ...existingNumbers);
            lastBillNo = maxNumber + 1;
            document.getElementById('billNo').value = `BILL-${lastBillNo}`;
        }
        
        function loadBillFromChallan() {
            const challanIndex = document.getElementById('challanSelect').value;
            
            if (challanIndex === '') {
                resetBillForm();
                return;
            }
            
            const challan = deliveryChallans[challanIndex];
            
            // Set bill number same as challan number
            document.getElementById('billNo').value = challan.challanNo.replace('DC-', 'BILL-');
            document.getElementById('billDate').value = challan.date;
            document.getElementById('billPRNo').value = challan.prNo || '';
            document.getElementById('billDeliveryTo').value = challan.deliveryTo;
            document.getElementById('billDeliveryAddress').value = challan.deliveryAddress;
            
            // Populate items from challan
            const itemsContainer = document.getElementById('billItems');
            itemsContainer.innerHTML = '';
            
            challan.items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bill-item-row';
                div.innerHTML = `
                    <input type="text" placeholder="Item" class="bill-item-name" value="${item.item}" required>
                    <input type="text" placeholder="Item Description" class="bill-item-desc" value="${item.description}" required>
                    <input type="number" placeholder="Qty" class="bill-item-qty" min="1" value="${item.quantity}" required oninput="calculateItemTotal(this)">
                    <input type="number" placeholder="Rate" class="bill-item-rate" min="0" step="0.01" value="0" required oninput="calculateItemTotal(this)">
                    <input type="text" placeholder="Amount" class="bill-item-total" readonly>
                    <button type="button" class="remove-item" onclick="removeBillItem(this)">&times;</button>
                `;
                itemsContainer.appendChild(div);
                calculateItemTotal(div.querySelector('.bill-item-qty'));
            });
            
            calculateBillTotal();
        }
        
        function addBillItem() {
            const container = document.getElementById('billItems');
            const div = document.createElement('div');
            div.className = 'bill-item-row';
            div.innerHTML = `
                <input type="text" placeholder="Item" class="bill-item-name" required>
                <input type="text" placeholder="Item Description" class="bill-item-desc" required>
                <input type="number" placeholder="Qty" class="bill-item-qty" min="1" value="1" required oninput="calculateItemTotal(this)">
                <input type="number" placeholder="Rate" class="bill-item-rate" min="0" step="0.01" required oninput="calculateItemTotal(this)">
                <input type="text" placeholder="Amount" class="bill-item-total" readonly>
                <button type="button" class="remove-item" onclick="removeBillItem(this)">&times;</button>
            `;
            container.appendChild(div);
        }
        
        function removeBillItem(button) {
            const container = document.getElementById('billItems');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
            calculateBillTotal();
        }
        
        function calculateItemTotal(input) {
            const row = input.closest('.bill-item-row');
            const qty = parseFloat(row.querySelector('.bill-item-qty').value) || 0;
            const rate = parseFloat(row.querySelector('.bill-item-rate').value) || 0;
            const total = qty * rate;
            
            row.querySelector('.bill-item-total').value = total.toFixed(2);
            calculateBillTotal();
        }
        
        function calculateBillTotal() {
            let totalQty = 0;
            let totalAmount = 0;
            
            document.querySelectorAll('#billItems .bill-item-row').forEach(row => {
                const qty = parseFloat(row.querySelector('.bill-item-qty').value) || 0;
                const amount = parseFloat(row.querySelector('.bill-item-total').value) || 0;
                
                totalQty += qty;
                totalAmount += amount;
            });
            
            document.getElementById('totalQty').value = totalQty;
            document.getElementById('totalAmount').value = formatNumber(totalAmount);
            
            // Update amount in words
            if (totalAmount > 0) {
                document.getElementById('amountInWords').style.display = 'block';
                document.getElementById('amountWords').textContent = numberToWords(totalAmount);
            } else {
                document.getElementById('amountInWords').style.display = 'none';
            }
        }
        
        function generateBill() {
            const billNo = document.getElementById('billNo').value;
            const date = document.getElementById('billDate').value;
            const prNo = document.getElementById('billPRNo').value;
            const deliveryTo = document.getElementById('billDeliveryTo').value;
            const deliveryAddress = document.getElementById('billDeliveryAddress').value;
            const items = [];
            
            // Collect items
            document.querySelectorAll('#billItems .bill-item-row').forEach((row, index) => {
                const itemName = row.querySelector('.bill-item-name').value;
                const desc = row.querySelector('.bill-item-desc').value;
                const qty = row.querySelector('.bill-item-qty').value;
                const rate = row.querySelector('.bill-item-rate').value;
                const total = row.querySelector('.bill-item-total').value;
                
                if (itemName && desc && qty && rate) {
                    items.push({
                        serial: index + 1,
                        item: itemName,
                        description: desc,
                        quantity: parseInt(qty) || 1,
                        rate: parseFloat(rate).toFixed(2),
                        amount: parseFloat(total).toFixed(2)
                    });
                }
            });
            
            if (items.length === 0) {
                alert('Please add at least one item');
                return;
            }
            
            // Calculate totals
            const totalQty = items.reduce((sum, item) => sum + parseInt(item.quantity), 0);
            const totalAmount = items.reduce((sum, item) => sum + parseFloat(item.amount), 0);
            
            // Save bill
            const bill = {
                billNo: billNo,
                date: date,
                prNo: prNo,
                deliveryTo: deliveryTo,
                deliveryAddress: deliveryAddress,
                items: items,
                totalQty: totalQty,
                totalAmount: totalAmount,
                amountInWords: numberToWords(totalAmount),
                createdAt: new Date().toISOString()
            };
            
            bills.push(bill);
            localStorage.setItem('bills', JSON.stringify(bills));
            
            // Generate printable bill
            printBill(bill);
            
            alert('Bill generated successfully!');
            closeBillModal();
        }
        
        function printBill(billData) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Bill - ${billData.billNo}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .header h1 { color: #2c3e50; margin-bottom: 5px; }
                        .bill-info { text-align: right; margin-bottom: 30px; }
                        .address-section { 
                            display: flex; 
                            justify-content: space-between;
                            margin-bottom: 30px;
                        }
                        .address-box { 
                            width: 48%; 
                            border: 1px solid #000;
                            padding: 15px;
                        }
                        .address-box h3 { margin-top: 0; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                        th, td { border: 1px solid #000; padding: 10px; text-align: left; }
                        th { background-color: #f0f0f0; }
                        .signature-section { 
                            display: flex; 
                            justify-content: space-between;
                            margin-top: 50px;
                        }
                        .signature-box { 
                            text-align: center;
                            width: 30%;
                        }
                        .signature-line { 
                            width: 200px; 
                            height: 1px; 
                            background: #000; 
                            margin: 40px auto 10px;
                        }
                        .bold { font-weight: bold; }
                        .numeric { text-align: right; }
                        .amount-words { 
                            background: #f8f9fa; 
                            border: 1px solid #ddd; 
                            padding: 15px; 
                            margin-top: 20px;
                            font-style: italic;
                        }
                        @media print {
                            body { margin: 10px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>BILL</h1>
                        <div class="bill-info">
                            <div><strong>Bill No:</strong> ${billData.billNo}</div>
                            <div><strong>Date:</strong> ${formatDate(billData.date)}</div>
                        </div>
                    </div>
                    
                    <div class="address-section">
                        <div class="address-box">
                            <h3>From MUDI</h3>
                            <p>Location: House#2, Road No #96, Gulshan-2</p>
                        </div>
                        
                        <div class="address-box">
                            <h3>To:</h3>
                            <p><strong>Delivery To:</strong> ${billData.deliveryTo}</p>
                            <p><strong>Delivery Address:</strong><br>${billData.deliveryAddress.replace(/\n/g, '<br>')}</p>
                            <p><strong>PR No:</strong> ${billData.prNo || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>SL</th>
                                <th>Item</th>
                                <th>Item Description</th>
                                <th>Qty</th>
                                <th class="numeric">Rate</th>
                                <th class="numeric">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${billData.items.map(item => `
                                <tr>
                                    <td>${item.serial}</td>
                                    <td>${item.item}</td>
                                    <td>${item.description}</td>
                                    <td>${item.quantity}</td>
                                    <td class="numeric">${formatNumber(item.rate)}</td>
                                    <td class="numeric">${formatNumber(item.amount)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3"><strong>Total</strong></td>
                                <td><strong>${billData.totalQty}</strong></td>
                                <td></td>
                                <td class="numeric"><strong>${formatNumber(billData.totalAmount)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div class="amount-words">
                        <strong>Amount in Words:</strong> ${billData.amountInWords}
                    </div>
                    
                    <div class="signature-section">
                        <div class="signature-box">
                            <p>Created By</p>
                            <div class="signature-line"></div>
                            <p class="bold">Salim Bhuiyan</p>
                            <p>Assistant Manager</p>
                        </div>
                        
                        <div class="signature-box">
                            <p>Authorised By</p>
                            <div class="signature-line"></div>
                            <p class="bold">Masru Ahmed Rafi</p>
                            <p>CEO</p>
                        </div>
                        
                        <div class="signature-box">
                            <p>Received By</p>
                            <div class="signature-line"></div>
                            <p>&nbsp;</p>
                            <p>&nbsp;</p>
                        </div>
                    </div>
                    
                    <script>
                        window.onload = function() {
                            window.print();
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        function resetBillForm() {
            document.getElementById('billItems').innerHTML = `
                <div class="bill-item-row">
                    <input type="text" placeholder="Item" class="bill-item-name" required>
                    <input type="text" placeholder="Item Description" class="bill-item-desc" required>
                    <input type="number" placeholder="Qty" class="bill-item-qty" min="1" value="1" required oninput="calculateItemTotal(this)">
                    <input type="number" placeholder="Rate" class="bill-item-rate" min="0" step="0.01" required oninput="calculateItemTotal(this)">
                    <input type="text" placeholder="Amount" class="bill-item-total" readonly>
                    <button type="button" class="remove-item" onclick="removeBillItem(this)">&times;</button>
                </div>
            `;
            document.getElementById('billPRNo').value = '';
            document.getElementById('billDeliveryTo').value = '';
            document.getElementById('billDeliveryAddress').value = '';
            generateBillNumber();
            calculateBillTotal();
        }
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function openTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.currentTarget.classList.add('active');
        }
        
        function showLoading(show) {
            if (show) {
                document.body.style.cursor = 'wait';
            } else {
                document.body.style.cursor = 'default';
            }
        }
        
        function loadSavedData() {
            // Load saved delivery challans and bills from localStorage
            deliveryChallans = JSON.parse(localStorage.getItem('deliveryChallans')) || [];
            bills = JSON.parse(localStorage.getItem('bills')) || [];
            
            // Update counters based on saved data
            updateChallanSelect();
        }
        
        function formatNumber(num) {
            const n = parseFloat(num) || 0;
            return n.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }
        
        function getStatusClass(status) {
            const statusStr = (status || '').toLowerCase();
            if (statusStr.includes('deliver') || statusStr.includes('complete')) {
                return 'status-delivered';
            } else if (statusStr.includes('cancel')) {
                return 'status-cancelled';
            } else {
                return 'status-pending';
            }
        }
        
        function numberToWords(num) {
            // Convert number to words
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
            const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            
            function convertHundreds(n) {
                if (n === 0) return '';
                let result = '';
                
                if (n >= 100) {
                    result += ones[Math.floor(n / 100)] + ' Hundred ';
                    n %= 100;
                }
                
                if (n >= 20) {
                    result += tens[Math.floor(n / 10)] + ' ';
                    n %= 10;
                } else if (n >= 10) {
                    result += teens[n - 10] + ' ';
                    return result;
                }
                
                if (n > 0) {
                    result += ones[n] + ' ';
                }
                
                return result;
            }
            
            let number = parseFloat(num) || 0;
            if (number === 0) return 'Zero Taka Only';
            
            let words = '';
            let decimalPart = Math.round((number - Math.floor(number)) * 100);
            
            // Convert integer part
            let integerPart = Math.floor(number);
            
            if (integerPart >= 10000000) {
                words += convertHundreds(Math.floor(integerPart / 10000000)) + 'Crore ';
                integerPart %= 10000000;
            }
            
            if (integerPart >= 100000) {
                words += convertHundreds(Math.floor(integerPart / 100000)) + 'Lakh ';
                integerPart %= 100000;
            }
            
            if (integerPart >= 1000) {
                words += convertHundreds(Math.floor(integerPart / 1000)) + 'Thousand ';
                integerPart %= 1000;
            }
            
            if (integerPart > 0) {
                words += convertHundreds(integerPart);
            }
            
            words = words.trim() + ' Taka';
            
            // Add decimal part
            if (decimalPart > 0) {
                words += ' and ' + convertHundreds(decimalPart).trim() + ' Paisa';
            }
            
            return words + ' Only';
        }
        
        function exportToExcel() {
            if (inventoryData.length === 0) {
                alert('No data to export');
                return;
            }
            
            try {
                const ws = XLSX.utils.json_to_sheet(inventoryData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Inventory Data");
                XLSX.writeFile(wb, "inventory_data.xlsx");
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting to Excel');
            }
        }
        
        function printDeliveryAnalysis() {
            const printContent = document.getElementById('delivery-analysis-table').outerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Delivery Analysis Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #000; padding: 10px; text-align: left; }
                        th { background-color: #f0f0f0; }
                        .numeric { text-align: right; }
                        h1 { text-align: center; }
                    </style>
                </head>
                <body>
                    <h1>Delivery Location Analysis Report</h1>
                    ${printContent}
                    <script>
                        window.onload = function() {
                            window.print();
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
    </script>
</body>
</html>
